environment:
    # Enforce sequential JIT'ing of files for controlled memory usage.
    HILTI_JIT_SEQUENTIAL: 1

    # Images for macOS
    IMAGE_MACOS_BIG_SUR:  big-sur-base
    IMAGE_MACOS_CATALINA: catalina-base

    # Branch to use for building the Zeek plugin.
    ZEEK_SPICY_BRANCH: main

zkg_macos_task:
  timeout_in: 120m

  osx_instance:
    image: $IMAGE_MACOS_BIG_SUR

  env:
    PATH: /opt/spicy/bin:${PATH}

  install_zeek_script:
    - brew install zeek

  install_spicy_script:
    - brew tap zeek/zeek
    - brew install spicy --HEAD

  prepare_script:
    - pip3 install zkg btest
    - zkg autoconfig && echo "@load packages" >>"$(zeek-config --site_dir)"/local.zeek
    - git clone --branch=$ZEEK_SPICY_BRANCH --recurse-submodules https://github.com/zeek/spicy-plugin
    - zkg install --skiptests --force spicy-plugin
    - rm -rf spicy-plugin
    - zeek -N _Zeek::Spicy

  test_script:
    - zkg test .

  install_script:
    # --force avoids prompts, --skiptests because tests ran already
    - zkg install --force --skiptests .

  check_script:
    - zeek -NN _Zeek::Spicy | grep -q ANALYZER_SPICY_TFTP
    - zeek -NN _Zeek::Spicy | grep Analyzer
    - (cd /tmp && zeek -r ${CIRRUS_WORKING_DIR}/tests/Traces/tftp_rrq.pcap local && test -e tftp.log && grep rfc1350.txt tftp.log)

  always:
      stderr_script: ./ci/show-zkg-stderr
